name: üê∫ Wolf Den - Autonomous Cloud Scanner

# Runs autonomous scans in GitHub's cloud - NO local machine needed
# Runs even if Shadow PC is off, internet is down, or system crashes
# This is BULLETPROOF infrastructure

on:
  schedule:
    # Overnight scan at 4:00 AM ET (9:00 AM UTC)
    - cron: '0 9 * * 1-5'
    
    # Pre-market scan at 6:00 AM ET (11:00 AM UTC)
    - cron: '0 11 * * 1-5'
    
    # Final check at 8:30 AM ET (1:30 PM UTC)
    - cron: '30 13 * * 1-5'
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml yfinance requests
    
    - name: üïê Determine scan type
      id: scantype
      run: |
        HOUR=$(date -u +%H)
        if [ "$HOUR" = "09" ]; then
          echo "type=overnight" >> $GITHUB_OUTPUT
          echo "script=overnight_monitor.py" >> $GITHUB_OUTPUT
        elif [ "$HOUR" = "11" ]; then
          echo "type=premarket" >> $GITHUB_OUTPUT
          echo "script=premarket_auto.py" >> $GITHUB_OUTPUT
        else
          echo "type=final_check" >> $GITHUB_OUTPUT
          echo "script=premarket_auto.py" >> $GITHUB_OUTPUT
        fi
    
    - name: üîç Run scan
      id: scan
      run: |
        python3 ${{ steps.scantype.outputs.script }} > scan_output.txt 2>&1 || true
        cat scan_output.txt
        
        # Save output for email
        echo "SCAN_OUTPUT<<EOF" >> $GITHUB_ENV
        cat scan_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    
    - name: üìä Check for alerts
      id: alert
      run: |
        # Check if RED or YELLOW alerts in output
        if grep -q "üî¥\|RED" scan_output.txt; then
          echo "level=RED" >> $GITHUB_OUTPUT
          echo "send_alert=true" >> $GITHUB_OUTPUT
        elif grep -q "‚ö†Ô∏è\|YELLOW" scan_output.txt; then
          echo "level=YELLOW" >> $GITHUB_OUTPUT
          echo "send_alert=true" >> $GITHUB_OUTPUT
        else
          echo "level=GREEN" >> $GITHUB_OUTPUT
          echo "send_alert=false" >> $GITHUB_OUTPUT
        fi
    
    - name: üìß Send email alert
      if: steps.alert.outputs.send_alert == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: üê∫ WOLF DEN ALERT - ${{ steps.alert.outputs.level }} - ${{ steps.scantype.outputs.type }}
        to: ${{ secrets.EMAIL_TO }}
        from: Wolf Den Scanner <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Wolf Den Autonomous Scanner
          
          Scan Type: ${{ steps.scantype.outputs.type }}
          Alert Level: ${{ steps.alert.outputs.level }}
          Time: ${{ github.event.head_commit.timestamp }}
          
          ${{ env.SCAN_OUTPUT }}
          
          ---
          This scan ran in GitHub's cloud.
          No local machine required.
          
          Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    - name: üíæ Save results as artifact
      uses: actions/upload-artifact@v3
      with:
        name: scan-results-${{ steps.scantype.outputs.type }}
        path: |
          scan_output.txt
          logs/*.json
          logs/*.txt
        retention-days: 90
    
    - name: ‚úÖ Commit results to repo
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "Wolf Den Bot"
        
        # Only commit if there are changes
        git add -A logs/ || true
        git diff --quiet && git diff --staged --quiet || \
          git commit -m "ü§ñ Autonomous scan: ${{ steps.scantype.outputs.type }} - ${{ steps.alert.outputs.level }}" || true
    
    - name: üì§ Push results
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
